---
title: 深拷贝和浅拷贝
updated: 2025-08-22T16:47:58
created: 2025-05-09T09:44:09
---


# 数据类型
数据分为**基本数据类型**和**对象数据类型**

**基本数据类型**：直接存储在栈中的数据

**引用数据类型**：存储的对象在栈中引用，真实的数据放在堆内存

# 深拷贝和浅拷贝
**深拷贝：改变新的数组（对象）的时候，不改变原数组（对象）**

**浅拷贝：只复制指向某个对象的指针，而不复制对象本身，新旧对象共享同一块内存**

深拷贝和浅拷贝只针对object和array这样的引用数据类型
1.  对浅拷贝，如果属性是基本类型，拷贝的基本类型的值；如果是内存引用，拷贝的是内存地址
2.  深拷贝会创造一个一模一样的对象，**和原对象不共享内存**
## 示例
### 浅拷贝示例
```c++
class ShallowCopy {
public:
    int* data;
    ShallowCopy(int val) {
        data = new int(val);
    }
    // 默认拷贝构造函数是浅拷贝
    ~ShallowCopy() {
        delete data;
    }
};

void shallowCopyDemo() {
    ShallowCopy a(10);
    ShallowCopy b = a;  // 浅拷贝
    
    // a和b的data指针指向同一内存
    *a.data = 20;       // 修改a会影响b
    std::cout << *b.data; // 输出20
    
    // 析构时会导致同一内存被释放两次（未定义行为）
}
```

### 深拷贝示例
```c++
class DeepCopy {
public:
    int* data;
    DeepCopy(int val) {
        data = new int(val);
    }
    // 自定义深拷贝构造函数
    DeepCopy(const DeepCopy& other) {
        data = new int(*other.data); // 分配新内存并复制值
    }
    // 深拷贝赋值运算符
    DeepCopy& operator=(const DeepCopy& other) {
        if (this != &other) {
            delete data;             // 释放原有资源
            data = new int(*other.data); // 分配新内存并复制值
        }
        return *this;
    }
    ~DeepCopy() {
        delete data;
    }
};

void deepCopyDemo() {
    DeepCopy a(10);
    DeepCopy b = a;  // 深拷贝
    
    *a.data = 20;    // 修改a不会影响b
    std::cout << *b.data; // 输出10
    
    // 析构时各自释放自己的内存，安全
}
```


# 移动语义
移动语义是C++11引入的一项重要特性，它允许资源（如动态内存、文件句柄等）的所有权从一个对象转移到另一个对象，而不是进行昂贵的深拷贝操作。

## 核心概念
### 1.​​右值引用（Rvalue Reference）​​：
- 使用&&表示，如T&&
- 只能绑定到右值（临时对象）

### 2.移动构造函数和移动赋值运算符​​：
- 特殊的成员函数，用于实现资源所有权的转移
## 移动语义的实现
### 移动构造函数
```c++
class MyString {
    char* data;
public:
    // 移动构造函数
    MyString(MyString&& other) noexcept 
        : data(other.data) {  // 窃取资源
        other.data = nullptr; // 置空原对象
    }
};
```
### 移动赋值运算符
```c++
class MyString {
    // ...
    MyString& operator=(MyString&& other) noexcept {
        if (this != &other) {
            delete[] data;      // 释放现有资源
            data = other.data;  // 窃取资源
            other.data = nullptr;
        }
        return *this;
    }
};
```
## 重要函数和关键字
### 1.```​​std::move```​​：

- 将左值转换为右值引用
- 实际上不移动任何东西，只是类型转换

### 2.```​​noexcept```​​：
- 移动操作通常标记为noexcept，因为不应抛出异常
